# wechat4node

## å†™ä½œèƒŒæ™¯ï¼š
**ğŸ’¢ç¬¬ä¸€å‘æ¥è‡ªaliäº‘ï¼Œaliäº‘çš„å‡½æ•°è®¡ç®—FCäº§å“åœ¨ä½¿ç”¨æ¨¡æ¿åˆ›å»ºé¡¹ç›®çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä¸‹å›¾ä¸­çš„æœåŠ¡åå’Œå‡½æ•°åæ¯æ¬¡åˆ›å»ºéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±æŒ‰é»˜è®¤çš„åˆ›å»ºäº†ï¼Œä½†æ˜¯å¤šæ¬¡åˆ›å»ºä¼šè¦†ç›–å‰ä¸€æ¬¡çš„å†…å®¹ï¼Œæˆ‘å†™å¥½çš„æˆæƒæ¥å£å°±è¢«è¦†ç›–äº†~**
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658762396888-189f0787-021f-44e5-aea0-d5d688e96829.png#clientId=ub46562fc-96b2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=448&id=uaf18ad52&margin=%5Bobject%20Object%5D&name=image.png&originHeight=448&originWidth=1983&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30288&status=done&style=shadow&taskId=udf804778-9607-4747-9b97-247362e2c31&title=&width=1983)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658762622452-539ab3a3-8563-4307-b79c-261d0250ef03.png#clientId=ub46562fc-96b2-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u005c734e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=218&originWidth=650&originalType=url&ratio=1&rotation=0&showTitle=false&size=34863&status=done&style=shadow&taskId=u01b632b4-61c6-4acb-a190-b1c76a10461&title=)
**ğŸ’˜aliçš„äº§å“åŸæ¥ä¹Ÿæœ‰è¿™ç§ä½çº§çš„é”™è¯¯ï¼Œä¸ç®¡ä½ æ˜¯äº§å“è®¾è®¡çš„ç¼ºé™·è¿˜æ˜¯ç³»ç»Ÿå¼€å‘çš„ç¼ºé™·ï¼Œè¿™éƒ½æ˜¯è‡´å‘½çš„ï¼Œå› ä¸ºæ­£å¸¸è¿è¡Œçš„æœåŠ¡ä¸¢äº†~**
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658762603386-3c18ec45-0bf3-46f4-9757-3442bf8d3c10.png#clientId=ub46562fc-96b2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=836&id=u1deadc8a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=836&originWidth=2293&originalType=binary&ratio=1&rotation=0&showTitle=false&size=85055&status=done&style=shadow&taskId=u30c2f83b-be21-43ea-b289-1ccf01363da&title=&width=2293)**ğŸ’¥ç¬¬äºŒå‘æ¥è‡ªWeChatï¼Œåœ¨aliäº‘è°ƒè¯•å¥½çš„ä»£ç ä¸¢å°±ä¸¢äº†å§ï¼Œæˆ‘å°±æ‰“ç®—è¿˜åœ¨aliäº‘ä¸Šå¼€å§‹é‡æ–°æ¥ä¸€éï¼Œé ç€æœç´¢åˆ°çš„ç½‘ç«™è¿˜æ²¡å…³æ‰ï¼Œå°±å†™å®Œäº†ç¬¬äºŒéäº‘ä¸Šçš„ä»£ç ï¼Œæ¥å£æµ‹è¯•å¯ä»¥è¿”å›ä¿¡æ¯ï¼Œä½†æ˜¯ã€æŠ˜ã€‘åœ¨äº†å‰ç«¯wx.configå‡½æ•°çš„æ ¡éªŒé—®é¢˜ä¸Šï¼Œå†™è¿‡çš„éƒ½çŸ¥é“æ–‡æ¡£æä¾›äº†æ ¡éªŒå¤±è´¥çš„æ’æŸ¥è¿‡ç¨‹ï¼Œä½ è¦æ˜¯èƒ½æŒ‰è¿™ä¸ªè§£å†³äº†ï¼Œå¾®ä¿¡å¼€å‘ç¤¾åŒºå°±ä¸ä¼šæ5k+è¿‘ä¼¼é‡å¤çš„é—®é¢˜è€Œæ²¡æœ‰ç»“æœäº†~**
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658762850917-5b843dc3-cd9e-4f44-9d43-9d8a8f3742b1.png#clientId=ub46562fc-96b2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=292&id=udeafccb7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=292&originWidth=1059&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55472&status=done&style=shadow&taskId=ua44a8fb1-b0d3-43a3-988b-e42a428f7e2&title=&width=1059)![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658762983648-25ba01f0-db2b-4ea9-bab5-b3fc337dfb9c.png#clientId=ub46562fc-96b2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=415&id=uda6aed7c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=415&originWidth=1239&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41868&status=done&style=shadow&taskId=u0a8da0d7-208f-497a-a960-07eb859f10b&title=&width=1239)
ğŸ’¤**å†™ä»£ç å°±åº”è¯¥ã€æœ‰å§‹æœ‰ç»ˆã€‘æˆ‘è¿˜æ˜¯åœ¨æœ¬åœ°æ­å»ºå…¨å¥—ç¯å¢ƒæ¥å†æä¸€éè¯•è¯•çœ‹ï¼Œè¯·ç†Ÿæ‚‰ä¸‹é¢å„ä¸ªåœ°å€çš„å¿«é€Ÿä¸Šæ‰‹æ–‡æ¡£æ¥æ­å»ºç¯å¢ƒ~**

1. **æœåŠ¡ç«¯ï¼š**[**Egg.js**](https://www.eggjs.org/zh-CN/intro/quickstart)
1. **å‰ç«¯ï¼š**[**Vue3**](https://staging-cn.vuejs.org/)
1. **å¾®ä¿¡ï¼š**[**å…¬ä¼—å·æµ‹è¯•å¹³å°**](https://mp.weixin.qq.com/debug/cgi-bin/sandboxinfo?action=showinfo&t=sandbox/index)
1. **å†…ç½‘ç©¿é€ï¼š**[Natapp](https://natapp.cn/)
## ä»£ç å®æ“ï¼š
### ç¬¬ä¸€æ­¥ï¼Œå¯åŠ¨Natappï¼š

1. åœ¨natappå¹³å°æ‰¾åˆ°å…è´¹æä¾›çš„éš§é“è¿›è¡Œé…ç½®æ›´æ”¹ï¼šå°†`7001`ç«¯å£è¿›è¡Œæ˜ å°„ï¼Œ`7001`æ˜¯eggjsé¡¹ç›®é»˜è®¤ç«¯å£ï¼›
1. åœ¨ä¸‹è½½å¥½natappå®¢æˆ·ç«¯ï¼ˆwindowï¼‰ååœ¨å®¢æˆ·ç«¯åŒçº§ç›®å½•ç¼–å†™`config.ini`é…ç½®æ–‡ä»¶å¹¶å°†å¹³å°æä¾›çš„å…è´¹éš§é“é”®å…¥åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œæ ¼å¼åŒï¼š`authtoken=<your authtoken>`ï¼›
1. é…ç½®ååŒå‡»å®¢æˆ·ç«¯å¦‚ä¸‹å›¾å°±å¯åŠ¨æ­£å¸¸äº†ï¼Œå…è´¹éš§é“çš„IPéšæ—¶å¯èƒ½ä¼šå˜ï¼Œå¼€å‘ä¸­éœ€è¦æ³¨æ„~![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658763589867-b9f2cb73-da38-414d-b758-ffe6d7e1223d.png#clientId=ub46562fc-96b2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=251&id=u921d5805&margin=%5Bobject%20Object%5D&name=image.png&originHeight=251&originWidth=828&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14420&status=done&style=shadow&taskId=u93c3d1ba-62db-4a65-96ec-12c6bfd27cd&title=&width=828)
### ç¬¬äºŒæ­¥ï¼Œå…ˆæå‰ç«¯éƒ¨åˆ†ï¼š

1. ä½¿ç”¨`yarn create vite`åˆ›å»ºä¸€ä¸ªå‰ç«¯é¡¹ç›®ï¼Œç”¨ç€é¡ºæ‰‹å°±è¡Œï¼Œä¸ºçš„å°±æ˜¯**å¿«~**
1. å®‰è£…`axios`æ¥å‘é€æˆæƒä¿¡æ¯è·å–è¯·æ±‚ï¼›
1. å¾®ä¿¡çš„JS-SDKæ—¢ç„¶æ²¡çœ‹åˆ°å®˜æ–¹æä¾›ä¾èµ–åŒ…é‚£å°±ç”¨é…ç½®åˆ°index.htmlï¼Œ`<script src="[http://res2.wx.qq.com/open/js/jweixin-1.6.0.js"></script>](http://res2.wx.qq.com/open/js/jweixin-1.6.0.js"></script>)`
1. åœ¨æ¨¡æ¿ä¸­æˆ‘ä»¬ç¼–å†™å°‘é‡çš„ä»£ç æ¥æ˜¾ç¤ºæˆæƒçš„çŠ¶æ€ï¼š
```html
<template>
  <h3 v-if="message">{{ message }}</h3>
  <h3 v-else>
    ç‚¹å‡»å³ä¸Šè§’=>åˆ†äº«ç»™æœ‹å‹
    <h5>{{ status }}</h5>
  </h3>
</template>
```

5. æˆ‘ä»¬é€šè¿‡`axios`è·å–`/signature`æ¥å£çš„æ•°æ®ï¼Œä¸ºäº†é¿å…**url**å‚æ•°çš„ä¼ é€’å¯èƒ½å­˜åœ¨ç¼–ç çš„é—®é¢˜ï¼Œé‚£æˆ‘ä»¬ç¨ååœ¨è®¾è®¡`/signature`æ¥å£çš„æ—¶å€™**url**å‚æ•°é€šè¿‡**body**ä¼ é€’æ¥é¿å…ï¼Œæˆæƒæ•°æ®æ‹¿åˆ°åå°±æ˜¯`wx.config`æ‰§è¡ŒéªŒè¯äº†~
```typescript
<script setup>
  import { ref } from "vue";
import axios from "axios";
const message = ref("");
const status = ref("");
axios
  .post(`http://t2fzbb.natappfree.cc/signature`, {
  url: location.href.split("#")[0],
})
  .then((res) => {
  const { appId, nonceStr, signature, timestamp } = res.data;
  console.log("[ res ] >", appId, nonceStr, signature, timestamp);
  wx.config({
    debug: true, // å¼€å¯è°ƒè¯•æ¨¡å¼,è°ƒç”¨çš„æ‰€æœ‰ api çš„è¿”å›å€¼ä¼šåœ¨å®¢æˆ·ç«¯ alert å‡ºæ¥ï¼Œè‹¥è¦æŸ¥çœ‹ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ pc ç«¯æ‰“å¼€ï¼Œå‚æ•°ä¿¡æ¯ä¼šé€šè¿‡ log æ‰“å‡ºï¼Œä»…åœ¨ pc ç«¯æ—¶æ‰ä¼šæ‰“å°ã€‚
    appId, // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
    timestamp, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
    nonceStr, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
    signature, // å¿…å¡«ï¼Œç­¾å
    jsApiList: ["updateAppMessageShareData"], // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„ JS æ¥å£åˆ—è¡¨
  });
  wx.error((res) => {
    message.value = res.errMsg;
  });
  wx.ready(() => {
    wx.checkJsApi({
      jsApiList: ["updateAppMessageShareData"], // éœ€è¦æ£€æµ‹çš„ JS æ¥å£åˆ—è¡¨ï¼Œæ‰€æœ‰ JS æ¥å£åˆ—è¡¨è§é™„å½•2,
      success: (res) => {
        wx.updateAppMessageShareData({
          title: "æˆ‘çš„æ˜é‡‘", // åˆ†äº«æ ‡é¢˜
          desc: "æˆ‘åœ¨æ˜é‡‘è¾“å‡ºå‰ç«¯çŸ¥è¯†~", // åˆ†äº«æè¿°
          link: "https://juejin.cn/user/3966693685871694", // åˆ†äº«é“¾æ¥ï¼Œè¯¥é“¾æ¥åŸŸåæˆ–è·¯å¾„å¿…é¡»ä¸å½“å‰é¡µé¢å¯¹åº”çš„å…¬ä¼—å· JS å®‰å…¨åŸŸåä¸€è‡´
          imgUrl:
          "https://p9-passport.byteacctimg.com/img/user-avatar/71ca4682501063257d8413ff726105a0~300x300.images", // åˆ†äº«å›¾æ ‡
          success: function () {
            status.value = "è®¾ç½®æˆåŠŸ";
          },
        });
      },
    });
  });
});
</script>
```
æœ€ç»ˆæˆ‘ä»¬è¦åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„å…¬ä¼—å°çœ‹åˆ°ä¸€å †**ok**å°±è¯´æ˜å¯ä»¥äº†~
![image.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658764406742-3e698acc-a4c0-45c5-a82f-d66ceeaf39db.png#clientId=ub46562fc-96b2-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=968&id=u3f6ed55e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=968&originWidth=1240&originalType=binary&ratio=1&rotation=0&showTitle=false&size=142095&status=done&style=shadow&taskId=u94209905-7996-4dd9-a735-b69a420aec8&title=&width=1240)
### ç¬¬ä¸‰æ­¥ï¼Œç¼–å†™æœåŠ¡ç«¯æ¥å£ï¼š
ğŸ¤£åœ¨å¼€å§‹å‰æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¾®ä¿¡çš„å„ç§**ç¥¨æ®**éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±åšç¼“å­˜å¤„ç†ï¼Œä»…åœ¨è¶…æ—¶åå†åˆ·æ–°ï¼Œè¦ä¸ä¼šé‡åˆ°è°ƒç”¨æ¬¡æ•°è¶…é™åˆ¶çš„éº»çƒ¦ï¼ŒæœåŠ¡ç«¯ç¼“å­˜**ç¥¨æ®**æˆ‘æœ€å…ˆæƒ³åˆ°çš„æ˜¯**Redis**ï¼Œä½†æ˜¯å¤šä¸€ä»½é…ç½®è¿˜æ˜¯æŒºéº»çƒ¦çš„ï¼Œåæ¥æƒ³åˆ°çš„æ˜¯**è¯»å†™æ–‡ä»¶**ï¼Œæˆ‘åœ¨ã€aliäº‘ã€‘çš„ä¸¤æ¬¡å°±æ˜¯é€šè¿‡è¯»å†™æ–‡ä»¶æ¥å®ç°çš„ï¼Œæ¯•ç«Ÿæ˜¯Demoï¼Œæ•ˆç‡é åå‘—~
ğŸ˜‹æœ€åæˆ‘æƒ³åˆ°çš„æ˜¯æœåŠ¡è¿è¡Œåæˆ‘å¯ä»¥ä½¿ç”¨å…¨å±€å¯¹è±¡æ¥ç¼“å­˜æ•°æ®å‘€ï¼Œå¹¶ä¸éœ€è¦å€ŸåŠ©é¢å¤–çš„æ¸ é“æ¥å®ç°ï¼Œæˆ‘ä»¬ä»¥å‰çš„**å•åˆ©æ¨¡å¼**å°±æ˜¯åœ¨éœ€è¦çš„æ—¶å€™å†å®ä¾‹åŒ–å¯¹è±¡çš„å‘€ğŸ’—
#### ç¼–å†™ä¸ªæ¥å£çš„Controllerå±‚ï¼š

1. checkOriginï¼šç”¨æ¥åœ¨å…¬ä¼—å·æµ‹è¯•å¹³å°å‘èµ·éªŒè¯æœåŠ¡çš„è¯·æ±‚æ¥éªŒè¯æ•°æ®æ¥æºï¼›
1. tokenï¼šç”¨æ¥è·å–`access_token`ï¼Œæˆ‘ä¼šåœ¨serverå±‚åš`access_token`çš„**å¯¹è±¡ç¼“å­˜**ï¼›
1. ticketï¼šç”¨æ¥è·å–`ticket`ï¼Œè¿™ä¸ªä¹Ÿä¼šåœ¨serverå±‚åš**å¯¹è±¡ç¼“å­˜**ï¼›
1. signatureï¼šç”¨æ¥ç”ŸæˆéªŒç­¾ï¼Œå¹¶è¿”å›**wx.config**éœ€è¦é…ç½®æ•°æ®ï¼ŒæœŸé—´éœ€è¦ä¸€æ¬¡è·å–`access_token`å’Œ`ticket`ï¼Œå¯ä»¥çœ‹åˆ°`url`æˆ‘ä»¬æ˜¯é€šè¿‡`body`è·å–çš„ã€‚
```typescript
import { Controller } from 'egg';

export default class HomeController extends Controller {
  
  public async checkOrigin() {
    const { ctx } = this;
    const { signature, timestamp, nonce, echostr } = ctx.query;
    const result = await ctx.service.weChat.checkSignature(
      signature,
      timestamp,
      nonce,
    );
    ctx.body = result ? echostr : '';
  }

  public async token() {
    const { ctx } = this;
    ctx.body = await ctx.service.weChat.getToken();
  }

  public async ticket() {
    const { ctx } = this;
    ctx.body = await ctx.service.weChat.getTicket();
  }

  public async signature() {
    const { ctx } = this;
    const { url } = ctx.request.body;
    console.log('[ url ] >', url);
    ctx.body = await ctx.service.weChat.genSignature(url);
  }
}

```
#### ç¼–å†™Serviceçš„ç¬¬ä¸€ä¸ªå‡½æ•°checkSignatureï¼š
ğŸ’•éœ€è¦æ¥å£å¾®ä¿¡å¹³å°å‘é€æ¥çš„**signature**ï¼Œ**timestamp**ï¼Œ**nonce**ï¼Œåœ¨æµ‹è¯•å¹³å°æˆ‘ä»¬é…ç½®äº†ä¸ªè‡ªå®šä¹‰çš„TOKENï¼Œæˆ‘ä»¬éœ€è¦å°†ã€TOKEN, timestamp, nonceã€‘è¿›è¡Œ**sort**æ’åºåæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨**SHA1**åŠ å¯†ç®—æ³•ï¼ˆè¿™é‡Œä½¿ç”¨çš„crypto-jsä¾èµ–ï¼‰æ¥ç”Ÿæˆæˆ‘ä»¬è‡ªå·±çš„**éªŒç­¾**ï¼Œå°†æˆ‘ä»¬çš„ç”Ÿæˆçš„**éªŒç­¾**å’Œå¹³å°å‘é€è¿‡æ¥çš„**signature**å¯¹æ¯”å¹¶å°†ç»“æœè¿”å›åˆ°Controllerï¼Œå¹¶å“åº”å¾®ä¿¡æµ‹è¯•å¹³å°~
```typescript
  public async checkSignature(
    signature: string,
    timestamp: string,
    nonce: string,
  ) {
    const own = SHA1([ TOKEN, timestamp, nonce ].sort().join('')).toString();
    return own === signature;
  }
```
#### ç¼–å†™Serviceçš„ç¬¬äºŒä¸ªå‡½æ•°getTokenï¼š

1. æˆ‘åœ¨æœåŠ¡çš„æœ€å¼€å§‹å®šä¹‰äº†ä¸€ä¸ª**cache**å¯¹è±¡æ¥ç¼“å­˜**token**ï¼›
1. å½“**token**ä¸­çš„`access_token`å­—æ®µä¸å­˜åœ¨æ—¶å°±éœ€è¦ä½¿ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­çš„`curl`æ¥å‘èµ·è¯·æ±‚è·å–ä¸€ä»½æ–°çš„`access_token`æ•°æ®ï¼›
1. åœ¨æ‹¿åˆ°æ–°æ•°æ®åé€šè¿‡`Date.now() + expires_in * 1000`å¾—åˆ°ä¸€ä¸ªå¤±æ•ˆçš„æ—¶é—´å¹¶èµ‹å€¼ç»™`last_time`ï¼›
1. å½“å‰çš„`Date.now()`å¤§äºå­˜å‚¨çš„`last_time`æ—¶éœ€è¦å†æ¬¡åˆ·æ–°`access_token`ã€‚
```typescript
const cache: {
  token: {
    access_token: string | undefined;
    expires_in: number;
    last_time: number;
  };
} = {
  token: {
    access_token: undefined,
    expires_in: 0,
    last_time: 0,
  }
};

public async getToken() {
  const { ctx } = this;
  const request = async () => {
    const { data } = await ctx.curl(URL_TOKEN, { dataType: 'json' });
    const { access_token, expires_in } = data;
    console.log('[ token data ] >', data);
    cache.token = {
      access_token,
      expires_in,
      last_time: Date.now() + expires_in * 1000,
    };
  };
  if (!cache.token.access_token) {
    console.log('[ token è¿˜æ²¡æœ‰~ ] ');
    await request();
  } else {
    if (Date.now() > cache.token.last_time) {
      console.log('[ token è¶…æ—¶äº† ] ');
      await request();
    }
  }
  return cache.token;
}
```
#### ç¼–å†™Serviceçš„ç¬¬ä¸‰ä¸ªå‡½æ•°getTicketï¼š
**ğŸ¤–getTicket**å’Œ**getToken**çš„ç¼“å­˜é€»è¾‘ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºgetTicketå‘èµ·è¯·æ±‚æ—¶éœ€è¦æºå¸¦`access_token`ï¼Œå…¶å®ƒç›´æ¥çœ‹ä»£ç ~
```typescript
const cache: {
  token: {
    access_token: string | undefined;
    expires_in: number;
    last_time: number;
  };
  ticket: {
    ticket: string | undefined;
    expires_in: number;
    last_time: number;
  };
} = {
  token: {
    access_token: undefined,
    expires_in: 0,
    last_time: 0,
  },
  ticket: {
    ticket: undefined,
    expires_in: 0,
    last_time: 0,
  },
};

public async getTicket() {
  const { ctx } = this;
  const request = async () => {
    const { access_token } = await this.getToken();
    const { data } = await ctx.curl(URL_TICKET, {
      dataType: 'json',
      method: 'GET',
      data: {
        access_token,
      },
    });
    const { ticket, expires_in } = data;
    console.log('[ ticket data ] >', data);
    cache.ticket = {
      ticket,
      expires_in,
      last_time: Date.now() + expires_in * 1000,
    };
  };
  if (!cache.ticket.ticket) {
    console.log('[ ticket è¿˜æ²¡æœ‰~ ] ');
    await request();
  } else {
    if (Date.now() > cache.ticket.last_time) {
      console.log('[ ticket è¶…æ—¶äº† ] ');
      await request();
    }
  }
  return cache.ticket;
}
```
#### ç¼–å†™Serviceçš„æœ€åä¸€ä¸ªå‡½æ•°genSignatureï¼š

1. è°ƒç”¨ä¸Šä¸€æ¬¡å‡½æ•°å¾—åˆ°`jsapi_ticket`ï¼›
1. ç”Ÿæˆéšæœºå­—ç¬¦ä¸²noncestrï¼š`Math.random().toString(36).substr(2, 15)`ï¼›
1. ç”Ÿæˆæ—¶é—´æˆ³timestampï¼š`Date.now()`ï¼›
1. ~~éªŒç­¾ç”Ÿæˆåœ¨å®˜ç½‘æè¿°ä¸­éœ€è¦ï¼š~~
   1. ~~å¯¹æ‰€æœ‰å¾…ç­¾åå‚æ•°æŒ‰ç…§å­—æ®µåçš„ASCII ç ä»å°åˆ°å¤§æ’åºï¼ˆå­—å…¸åºï¼‰ï¼›~~
   1. ~~ä½¿ç”¨ URL é”®å€¼å¯¹çš„æ ¼å¼ï¼ˆå³key1=value1&key2=value2â€¦ï¼‰æ‹¼æ¥æˆå­—ç¬¦ä¸²string1ï¼›~~
   1. ~~éœ€è¦æ³¨æ„çš„æ˜¯æ‰€æœ‰å‚æ•°åå‡ä¸ºå°å†™å­—ç¬¦ï¼›~~
   1. ~~å¯¹string1ä½œsha1åŠ å¯†ï¼Œå­—æ®µåå’Œå­—æ®µå€¼éƒ½é‡‡ç”¨åŸå§‹å€¼ï¼Œä¸è¿›è¡ŒURL è½¬ä¹‰ï¼›~~
5. å®˜ç½‘çš„æè¿°å¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä»¬ç›´æ¥æŒ‰ASCII ç ä»å°åˆ°å¤§å‡­å€Ÿæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œæ’åºã€é”®å€¼å¯¹æ ¼å¼ã€å¤§å°å†™è¿™äº›æ³¨æ„äº‹é¡¹å°±éƒ½çœäº†ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰ç¬¬ä¸€ä¸ªå‡½æ•°ä¸­åšä¸€æ¬¡`SHA1`åŠ å¯†å¹¶`toString()`å¾—åˆ°éªŒç­¾å­—ç¬¦ä¸²å°±å¯ä»¥le~
5. ç»„è£…å‰ç«¯`wx.config`ä¸­éœ€è¦çš„å››ä¸ªå‚æ•°å¹¶è¿”å›~
```typescript
public async genSignature(url: string) {
  const { ticket: jsapi_ticket } = await this.getTicket();
  const noncestr = Math.random().toString(36).substr(2, 15);
  const timestamp = Date.now();
  const signature = SHA1(
    `jsapi_ticket=${jsapi_ticket}&noncestr=${noncestr}&timestamp=${timestamp}&url=${url}`,
  ).toString();
  return {
    appId: APPID,
    nonceStr: noncestr,
    timestamp,
    signature,
  };
}
```
## å¾®ä¿¡æµ‹è¯•å·å¹³å°ï¼š
![uTools_1658766397916.png](https://cdn.nlark.com/yuque/0/2022/png/2373519/1658766495601-d6ae9d80-fe20-49fd-bf07-70aabc26ec9a.png#clientId=u5b222d9c-5eae-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=695&id=dab96&margin=%5Bobject%20Object%5D&name=uTools_1658766397916.png&originHeight=695&originWidth=1193&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45177&status=done&style=shadow&taskId=ud843cc43-3f68-471a-8873-31e9aced1ad&title=&width=1193)
### æ¥å£é…ç½®ä¿¡æ¯ï¼š
ğŸ’¥éœ€è¦è°ƒç”¨æˆ‘ä»¬çš„`/checkOrigin`ï¼ŒTokenå­—æ®µä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„å†…å®¹ï¼Œå’ŒæœåŠ¡ä¸­éªŒè¯ç­¾åæ—¶ä½¿ç”¨çš„ä¸€è‡´å°±å¯ä»¥äº†ï¼Œé…ç½®æäº¤åä¼šå‘æˆ‘ä»¬çš„æœåŠ¡å‘èµ·**GET**è¯·æ±‚ï¼Œå¹¶é€šè¿‡queryæºå¸¦å‚æ•°ç»™æˆ‘ä»¬ï¼Œå½“æˆ‘ä»¬éªŒè¯é€šè¿‡åéœ€è¦å°†å¹³å°ä¼ é€’è¿‡æ¥çš„éšæœºå­—ç¬¦è¿”å›å›å»ä»£è¡¨æˆ‘ä»¬éªŒè¯é€šè¿‡~
### JSæ¥å£å®‰å…¨åŸŸåï¼š
è¿™ä¸ªå› ä¸ºæˆ‘ä»¬åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è°ƒè¯•å‰ç«¯é¡µé¢ç”¨çš„`localhost`ï¼Œæ‰€ä»¥éœ€è¦å°†`localhost`é…ç½®åœ¨è¿™ä¸ªåœ°æ–¹~
## æ€»ç»“ï¼š
ğŸ’¯ä»£ç çš„ç¼–å†™è¿˜æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œå°±æ˜¯å’Œè¿™ç§å¤§å¹³å°æ²Ÿé€šæˆæœ¬å¤ªé«˜ï¼Œæ¯æ¬¡ç¼–å†™éƒ½æœ‰æ–°å‘è¦è¸©ï¼Œæœ€åæˆ‘å°†ä»£ç çš„é…ç½®ä¿¡æ¯å‰”é™¤åä¸Šä¼ åˆ°[GitHub](https://github.com/OSpoon/)ï¼Œéœ€è¦çš„jymå¯ä»¥ä¸‹è½½è·‘è·‘çœ‹~
